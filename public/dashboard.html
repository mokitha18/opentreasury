<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Event and Transaction Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Dashboard</h2>
    
    <!-- Add Event Form -->
    <h3>Add New Event</h3>
    <form id="addEventForm">
        <label for="eventName">Event Name:</label>
        <input type="text" id="eventName" required><br><br>

        <label for="budgetAllocated">Budget Allocated:</label>
        <input type="number" id="budgetAllocated" required><br><br>

        <label for="amountSpent">Amount Spent:</label>
        <input type="number" id="amountSpent" required><br><br>

        <label for="status">Status:</label>
        <select id="status" required>
            <option value="Planned">Planned</option>
            <option value="Ongoing">Ongoing</option>
            <option value="Completed">Completed</option>
        </select><br><br>

        <button type="submit">Add Event</button>
    </form>

    <!-- Add Transaction Form -->
    <h3>Add New Transaction</h3>
    <form id="addTransactionForm">
        <label for="transactionEvent">Event Name:</label>
        <input type="text" id="transactionEvent" required><br><br>

        <label for="transactionAmount">Amount:</label>
        <input type="number" id="transactionAmount" required><br><br>

        <label for="transactionDate">Date:</label>
        <input type="date" id="transactionDate" required><br><br>

        <button type="submit">Add Transaction</button>
    </form>

    <!-- Chart for Event Budget vs Spending -->
    <h3>Event Budget vs. Spending</h3>
    <canvas id="eventChart" width="400" height="200"></canvas>

    <!-- Tables to Display Events and Transactions -->
    <h3>Events Table</h3>
    <table id="eventsTable" border="1">
        <thead>
            <tr>
                <th>Name</th>
                <th>Budget Allocated</th>
                <th>Amount Spent</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic content will be inserted here -->
        </tbody>
    </table>

    <h3>Transactions Table</h3>
    <table id="transactionsTable" border="1">
        <thead>
            <tr>
                <th>Event Name</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic content will be inserted here -->
        </tbody>
    </table>

    <script>
        // Check if the user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';  // Redirect to login if not logged in
        }

        // Fetch events and transactions from backend
        fetchEventsAndTransactions(token);

        function fetchEventsAndTransactions(token) {
            // Fetch events
            fetch('http://localhost:3000/events', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(events => {
                // Populate Events Table
                const eventsTable = document.getElementById('eventsTable').getElementsByTagName('tbody')[0];
                events.forEach(event => {
                    const row = eventsTable.insertRow();
                    row.insertCell(0).innerText = event.name;
                    row.insertCell(1).innerText = event.budget_allocated;
                    row.insertCell(2).innerText = event.amount_spent;
                    row.insertCell(3).innerText = event.status;
                });

                // Populate Event Chart
                const eventNames = events.map(event => event.name);
                const allocatedBudgets = events.map(event => event.budget_allocated);
                const actualSpending = events.map(event => event.amount_spent);

                const ctx = document.getElementById('eventChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: eventNames,
                        datasets: [{
                            label: 'Budget Allocated',
                            data: allocatedBudgets,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }, {
                            label: 'Amount Spent',
                            data: actualSpending,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching events:', error));

            // Fetch transactions
            fetch('http://localhost:3000/transactions', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(transactions => {
                // Populate Transactions Table
                const transactionsTable = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
                transactions.forEach(transaction => {
                    const row = transactionsTable.insertRow();
                    row.insertCell(0).innerText = transaction.event_name;
                    row.insertCell(1).innerText = transaction.amount;
                    row.insertCell(2).innerText = transaction.date;
                });
            })
            .catch(error => console.error('Error fetching transactions:', error));
        }

        // Handle adding an event
        document.getElementById('addEventForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const eventData = {
                name: document.getElementById('eventName').value,
                budget_allocated: document.getElementById('budgetAllocated').value,
                amount_spent: document.getElementById('amountSpent').value,
                status: document.getElementById('status').value
            };

            fetch('http://localhost:3000/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Event Added: ' + data.eventId);
                fetchEventsAndTransactions(token);  // Refresh events and transactions table
            })
            .catch(error => console.error('Error adding event:', error));
        });

        // Handle adding a transaction
        document.getElementById('addTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const token = localStorage.getItem('token');
            const transactionData = {
                event_name: document.getElementById('transactionEvent').value,
                amount: document.getElementById('transactionAmount').value,
                date: document.getElementById('transactionDate').value
            };

            fetch('http://localhost:3000/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(transactionData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Transaction Added: ' + data.transactionId);
                fetchEventsAndTransactions(token);  // Refresh transactions table
            })
            .catch(error => console.error('Error adding transaction:', error));
        });
    </script>
</body>
</html>
